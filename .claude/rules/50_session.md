# 50. セッション管理（中断・再開）

Claude Code の max-turns や token 制限に対応するため、作業の中断と再開を適切に行う。

## 中断の判断基準

以下の状況で作業を中断する:
- 残り turns が少なくなったと感じたとき（目安: 残り10turns以下）
- 大きなタスクの区切りが来たとき
- エラーが続いて解決の目処が立たないとき

## 中断時にやること

### 1. 作業ログを残す
Issue/PR コメントに以下を記録:
- **完了した作業**: 何を終えたか
- **未完了の作業**: 何が残っているか
- **現在の状態**: どこで止まっているか（ファイル名、行番号等）
- **次にやるべきこと**: 再開時の最初のアクション
- **仮定・判断**: 実装中に行った仮定や判断

### 2. 差分をブランチに保存
```bash
# ステージング
git add -A

# 中断コミット（WIPであることを明示）
git commit -m "WIP: [作業内容の要約]

中断理由: [max-turns/token制限/エラー等]
残りタスク:
- [ ] タスク1
- [ ] タスク2

Co-Authored-By: Claude <noreply@anthropic.com>"

# プッシュ
git push origin <current-branch>
```

### 3. ブランチ命名規則

継続作業用のブランチ命名:
- 形式: `claude/<issue-type>-<issue-number>-<YYYYMMDD>-<HHMM>`
- 例: `claude/issue-42-20250129-1530`
- 例: `claude/pr-123-20250129-1530`

中断時の追加ブランチが必要な場合:
- 形式: `claude/wip/<issue-number>-<連番>`
- 例: `claude/wip/42-1`, `claude/wip/42-2`

## 再開時にやること

### 1. 過去のコンテキストを確認
- Issue/PR のコメントで前回の作業ログを確認
- 特に「次にやるべきこと」を最優先で確認

### 2. ブランチの状態を確認
```bash
# 差分確認
git log --oneline -5
git diff HEAD~1

# WIPコミットがあれば内容を確認
git show HEAD
```

### 3. Token節約のための工夫
- 前回のコメントログを参照し、同じ調査を繰り返さない
- 既にわかっている情報は再調査しない
- 前回の判断・仮定をそのまま引き継ぐ（変更が必要な場合のみ再検討）

## コメントログのフォーマット

中断時のコメントは以下の形式で記録:

```markdown
### 🔄 作業を中断します

#### 完了した作業
- [x] タスク1の説明
- [x] タスク2の説明

#### 未完了の作業
- [ ] タスク3の説明
- [ ] タスク4の説明

#### 現在の状態
- ファイル: `src/example.ts:42`
- 状態: [具体的な状態]

#### 次にやるべきこと
1. [最初のアクション]
2. [次のアクション]

#### 仮定・判断
- [実装中に行った仮定]
- [判断とその理由]

---
ブランチ: `claude/issue-XX-YYYYMMDD-HHMM`
コミット: `abc1234`
```

## 注意事項

- 中断は「失敗」ではない。計画的な中断はtoken効率を上げる
- 再開時は必ず前回のログを読んでから作業を開始する
- 複数回の中断・再開が予想される大きなタスクは、最初から分割を検討する
