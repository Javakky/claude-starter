name: "Prepare Claude Context"
description: "このアクションの主な目的は、特定のイベント（プルリクエストの更新やIssueへのコメント）をトリガーとして、後続のClaude Codeワークフローを実行すべきかどうかを判断し、そのために必要な情報を準備することです"

inputs:
  mode:
    description: "review / implement / plan / breakdown"
    required: true

  impl_workflow_id:
    description: "implementモードのワークフローがすでに実行中かどうかをチェックするための、ワークフローのファイル名またはIDです（e.g. claude.yml）"
    required: true

  skip_commit_prefixes:
    description: "ここで指定されたプレフィックスで始まるコミットメッセージを持つPRのレビューをスキップします（e.g. docs:,style:,chore:,wip:）"
    required: false
    default: "docs:,style:,chore:,wip:"
  allow_final_sync_during_impl:
    description: "implementの実行中に行われたPRの同期（push）に対するレビューを許可するかどうか"
    required: false
    default: "true"

  allowed_comment_permissions:
    description: "コメントによってアクションをトリガーできるユーザーのリポジトリに対する権限レベルを指定します（e.g. admin, write）"
    required: false
    default: "admin,maintain,write"
  max_workflow_runs_to_scan:
    description: "実行中のワークフローをチェックする際に、スキャンする最新のワークフロー実行履歴の最大数です"
    required: false
    default: "50"

  issue_branch_prefix:
    description: "implementモードでIssueから新しいブランチを作成する際の、ブランチ名の接頭辞です(e.g. claude/issue-）"
    required: false
    default: "claude/issue-"
  compare_base_branch:
    description: "新しいブランチを作成する際の元となるブランチ名です（e.g. master/main）"
    required: false
    default: "master"

outputs:
  should_run:
    description: "Claude の処理を実行するべきか？"
    value: ${{ steps.ctx.outputs.should_run }}
  reason:
    description: "スキップする理由"
    value: ${{ steps.ctx.outputs.reason }}
  trigger_kind:
    description: "ワークフローの起動理由"
    value: ${{ steps.ctx.outputs.trigger_kind }}

  issue_number:
    description: "Issue number"
    value: ${{ steps.ctx.outputs.issue_number }}
  issue_url:
    description: "Issue URL"
    value: ${{ steps.ctx.outputs.issue_url }}

  pr_number:
    description: "PR number (PR上で実行された場合のみ)"
    value: ${{ steps.ctx.outputs.pr_number }}
  head_sha:
    description: "対象のコミットハッシュ"
    value: ${{ steps.ctx.outputs.head_sha }}
  head_ref:
    description: "対象のブランチ"
    value: ${{ steps.ctx.outputs.head_ref }}

  comment_body:
    description: "comment body if issue_comment, otherwise empty"
    value: ${{ steps.ctx.outputs.comment_body }}

  milestone_number:
    description: "Milestone number (breakdown モードで Issue に milestone が紐付いている場合)"
    value: ${{ steps.ctx.outputs.milestone_number }}
  milestone_title:
    description: "Milestone title (breakdown モードで Issue に milestone が紐付いている場合)"
    value: ${{ steps.ctx.outputs.milestone_title }}

  mention_type:
    description: "メンションの種類（claude または codex）"
    value: ${{ steps.ctx.outputs.mention_type }}

runs:
  using: "composite"
  steps:
    - id: ctx
      uses: actions/github-script@v7
      env:
        MODE: ${{ inputs.mode }}
        IMPL_WORKFLOW_ID: ${{ inputs.impl_workflow_id }}

        SKIP_COMMIT_PREFIXES: ${{ inputs.skip_commit_prefixes }}
        ALLOW_FINAL_SYNC_DURING_IMPL: ${{ inputs.allow_final_sync_during_impl }}

        ALLOWED_COMMENT_PERMISSIONS: ${{ inputs.allowed_comment_permissions }}
        MAX_WORKFLOW_RUNS_TO_SCAN: ${{ inputs.max_workflow_runs_to_scan }}

        ISSUE_BRANCH_PREFIX: ${{ inputs.issue_branch_prefix }}
        COMPARE_BASE_BRANCH: ${{ inputs.compare_base_branch }}
      with:
        script: |
          const modeRaw = process.env.MODE;
          const mode = String(modeRaw || '').trim().toLowerCase();
          core.info(`modeRaw=${JSON.stringify(modeRaw)} mode=${mode}`);

          const implWorkflowId = String(process.env.IMPL_WORKFLOW_ID || '').trim();

          const skipPrefixes = String(process.env.SKIP_COMMIT_PREFIXES || '')
            .split(',')
            .map(s => s.trim().toLowerCase())
            .filter(Boolean);

          const allowFinalSync = String(process.env.ALLOW_FINAL_SYNC_DURING_IMPL || 'true').toLowerCase() === 'true';

          const allowedPerms = new Set(
            String(process.env.ALLOWED_COMMENT_PERMISSIONS || 'admin,maintain,write')
              .split(',')
              .map(s => s.trim().toLowerCase())
              .filter(Boolean)
          );

          const maxRuns = Math.min(Math.max(Number(process.env.MAX_WORKFLOW_RUNS_TO_SCAN || '50'), 1), 100);

          const issueBranchPrefixRaw = String(process.env.ISSUE_BRANCH_PREFIX || 'claude/issue-');
          // Sanitize the branch prefix to avoid invalid characters.
          // Ref: https://git-scm.com/docs/git-check-ref-format
          const issueBranchPrefix = issueBranchPrefixRaw.replace(/[\s\\~^:?*\[\]]|(\.\.)|@\{/g, '-').replace(/^-+|-+$/g, '');
          if (issueBranchPrefixRaw !== issueBranchPrefix) {
            core.warning(`Sanitized 'issue_branch_prefix' from '${issueBranchPrefixRaw}' to '${issueBranchPrefix}'`);
          }
          const compareBaseBranch = String(process.env.COMPARE_BASE_BRANCH || 'master');

          function setOut(obj) {
            core.setOutput('should_run', obj.should_run ? 'true' : 'false');
            core.setOutput('reason', obj.reason || '');
            core.setOutput('trigger_kind', obj.trigger_kind || 'none');

            core.setOutput('issue_number', obj.issue_number ? String(obj.issue_number) : '');
            core.setOutput('issue_url', obj.issue_url || '');

            core.setOutput('pr_number', obj.pr_number ? String(obj.pr_number) : '');
            core.setOutput('head_sha', obj.head_sha || '');
            core.setOutput('head_ref', obj.head_ref || '');

            core.setOutput('comment_body', obj.comment_body || '');

            core.setOutput('milestone_number', obj.milestone_number ? String(obj.milestone_number) : '');
            core.setOutput('milestone_title', obj.milestone_title || '');

            core.setOutput('mention_type', obj.mention_type || '');
          }

          const skip = (reason, extra = {}) => setOut({ should_run: false, reason, ...extra });
          const ok = (extra = {}) => setOut({ should_run: true, reason: '', ...extra });

          /** 実行中の対象のワークフロー (claude.yml) の一覧を取得する */
          async function listRunsForWorkflow(workflowId, perPage) {
            const res = await github.request(
              'GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs',
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowId,
                per_page: perPage,
              }
            );
            return res.data?.workflow_runs || [];
          }

          /** Claude が生成するブランチ名から issue ID を推察する */
          function inferIssueNumberFromHeadRef(headRef) {
            // headRef: "claude/issue-18-20260201-1418" -> "18"
            const m = String(headRef || '').match(/^claude\/issue-(\d+)-/);
            return m ? m[1] : '';
          }
          
          /** 同じ PR で実行中の実装があるかを確認する */
          async function isImplementRunning({ prNumber, headRef, headSha }) {
            if (!implWorkflowId) return false;

            const inferredIssue = inferIssueNumberFromHeadRef(headRef);

            // PR と ISSUE の ID が入る
            const keys = [];
            if (prNumber) {
              keys.push(`pr #${prNumber}`.toLowerCase(), `issue #${prNumber}`.toLowerCase());
            }
            if (inferredIssue && inferredIssue !== prNumber) {
              keys.push(`issue #${inferredIssue}`.toLowerCase());
            }

            try {
              const runs = await listRunsForWorkflow(implWorkflowId, maxRuns);

              // 実装が進行中なら全ての処理は中断されるので some で判定するだけでよい
              return runs.some(r => {
                if (!['queued', 'in_progress'].includes(r.status)) return false;

                const prs = r.pull_requests || [];
                if (prNumber && prs.some(p => String(p.number) === String(prNumber))) return true;

                // run-name は r.name に入ることがあるので両方見る
                const title = String(r.name || r.display_title || '').toLowerCase();
                if (keys.length && keys.some(k => title.includes(k))) return true;

                if (headRef && String(r.head_branch || '') === String(headRef)) return true;
                if (headSha && String(r.head_sha || '') === String(headSha)) return true;

                return false;
              });
            } catch (e) {
              core.info(`implement-running check failed (ignored): ${e.message}`);
              return false;
            }
          }

          function formatUtcYmdHm(isoString) {
            const d = isoString ? new Date(isoString) : new Date();
            const y = d.getUTCFullYear();
            const m = String(d.getUTCMonth() + 1).padStart(2, '0');
            const day = String(d.getUTCDate()).padStart(2, '0');
            const hh = String(d.getUTCHours()).padStart(2, '0');
            const mm = String(d.getUTCMinutes()).padStart(2, '0');
            return `${y}${m}${day}-${hh}${mm}`;
          }

          const ev = context.eventName;

          if (ev === 'pull_request') {
            const pr = context.payload.pull_request;
            const prNumber = String(pr?.number || '');
            const headSha = pr?.head?.sha || '';
            const headRef = pr?.head?.ref || '';
            const fullName = pr?.head?.repo?.full_name || '';
            const isFork = fullName !== `${context.repo.owner}/${context.repo.repo}`;

            const triggerKind = 'pr-sync';

            // 実装タスクは PR 更新で自動発火すべきでない
            if (mode !== 'review') {
              return skip('mode-mismatch:want-review', { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });
            }
            // fork や commit がない PR はレビューしない
            if (!headSha) return skip('no-head-sha', { issue_number: prNumber, pr_number: prNumber, trigger_kind: triggerKind });
            if (isFork) return skip('fork-pr-skip', { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });

            // pr_sync かつ force push の場合スキップ
            if (context.payload.action === 'synchronize') {
              const before = context.payload.before;
              const after = context.payload.after;
              if (before && after) {
                try {
                  const cmp = await github.rest.repos.compareCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    base: before,
                    head: after,
                  });
                  const status = String(cmp.data?.status || '').toLowerCase();
                  const isNormal = (status === 'ahead' || status === 'identical');
                  if (!isNormal) {
                    return skip(`force-push:${status}`, { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });
                  }
                } catch (e) {
                  return skip('force-push:compare-failed', { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });
                }
              }
            }

            let headCommitMsg = '';
            // コミットメッセージの先頭が wip: などならスキップ
            try {
              const commitResp = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
              });
              headCommitMsg = String(commitResp.data?.commit?.message || '');
              const msgLower = headCommitMsg.toLowerCase();
              if (skipPrefixes.some(p => msgLower.startsWith(p))) {
                return skip(`skip-commit-prefix:${msgLower.split('\n')[0]}`, { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });
              }
            } catch (_) {}

            // 実装中はレビューを止める
            // bot による pr_sync コミットによる発火は実装の完了を表すのでスキップしない
            const implementing = await isImplementRunning({ prNumber, headRef, headSha });
            if (implementing) {
              const isSync = context.payload.action === 'synchronize';
              const senderType = String(context.payload.sender?.type || '');
              const allow = allowFinalSync && isSync && (senderType === 'Bot');
              if (!allow) {
                return skip('implement-running', { issue_number: prNumber, pr_number: prNumber, head_sha: headSha, head_ref: headRef, trigger_kind: triggerKind });
              }
            }

            return ok({
              issue_number: prNumber,
              issue_url: pr?.html_url || '',
              pr_number: prNumber,
              head_sha: headSha,
              head_ref: headRef,
              comment_body: '',
              trigger_kind: triggerKind,
            });
          }
          
          // ここからコメントによる発火

          if (ev !== 'issue_comment') {
            return skip(`unsupported-event:${ev}`);
          }

          const issue = context.payload.issue;
          const issueNumber = String(issue?.number || '');
          const issueUrl = String(issue?.html_url || '');
          const comment = context.payload.comment;
          const commentBody = String(comment?.body || '');
          const commentUserType = String(comment?.user?.type || '');

          if (!issueNumber) return skip('no-issue-number');
          
          // bot のコメントで実装は発火しない 
          if (commentUserType.toLowerCase() === 'bot') {
            return skip('bot-comment', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody });
          }

          const normalized = commentBody.replaceAll('＠', '@').toLowerCase();
          const hasClaude = normalized.includes('@claude');
          const hasCodex = normalized.includes('@codex');
          const hasMention = hasClaude || hasCodex;
          const mentionType = hasClaude ? 'claude' : hasCodex ? 'codex' : '';
          const hasReview = normalized.includes('[review]');
          const hasPlan = normalized.includes('[plan]');
          const hasBreakdown = normalized.includes('[breakdown]');

          if (!hasMention) {
            return skip('no-mention', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody });
          }

          // TODO: より先頭で判定した方がよさそう
          let triggerKind = 'none';
          if (hasReview) {
            triggerKind = 'comment-review';
            if (mode !== 'review') return skip('mode-mismatch:want-review', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          } else if (hasPlan) {
            triggerKind = 'comment-plan';
            if (mode !== 'plan') return skip('mode-mismatch:want-plan', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          } else if (hasBreakdown) {
            triggerKind = 'comment-breakdown';
            if (mode !== 'breakdown') return skip('mode-mismatch:want-breakdown', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          } else {
            triggerKind = 'comment-implement';
            if (mode !== 'implement') return skip('mode-mismatch:want-implement', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          }

          // 実装はコメント者に事前指定された以上の権限がないなら発火しない
          const permResp = await github.rest.repos.getCollaboratorPermissionLevel({
            owner: context.repo.owner,
            repo: context.repo.repo,
            username: context.actor,
          });
          const perm = String(permResp.data?.permission || '').toLowerCase();
          if (!allowedPerms.has(perm)) {
            return skip(`unauthorized:${perm}`, { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          }

          const isPrConversation = !!issue?.pull_request;

          // issue 上でのレビューはサポートしていない
          if (mode === 'review' && !isPrConversation) {
            return skip('comment-review-on-issue-not-supported', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
          }

          if (isPrConversation) {
            // plan / breakdown は Issue コメントのみ対応（PR コメントは非サポート）
            if (triggerKind === 'comment-plan') {
              return skip('plan-on-pr-not-supported', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
            }
            if (triggerKind === 'comment-breakdown') {
              return skip('breakdown-on-pr-not-supported', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
            }

            // GitHub では issue と PR の番号は通しなので同じように扱える
            const prNumber = issueNumber;

            try {
              const prResp = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: Number(prNumber),
              });
              const pr = prResp.data;

              const headSha = pr.head?.sha || '';
              const headRef = pr.head?.ref || '';
              const fullName = pr.head?.repo?.full_name || '';
              const isFork = fullName !== `${context.repo.owner}/${context.repo.repo}`;
              // fork や branch が既に削除された PR に実装は追加しない
              if (isFork) {
                return skip('fork-pr-skip', { issue_number: issueNumber, issue_url: issueUrl, pr_number: prNumber, head_sha: headSha, head_ref: headRef, comment_body: commentBody, trigger_kind: triggerKind });
              }
              if (!headRef) {
                return skip('no-head-ref', { issue_number: issueNumber, issue_url: issueUrl, pr_number: prNumber, comment_body: commentBody, trigger_kind: triggerKind });
              }

              // 実装タスクの実行中はレビューをスキップする
              if (mode === 'review') {
                const implementing = await isImplementRunning({ prNumber, headRef, headSha });
                if (implementing) {
                  return skip('implement-running', { issue_number: issueNumber, issue_url: issueUrl, pr_number: prNumber, head_sha: headSha, head_ref: headRef, comment_body: commentBody, trigger_kind: triggerKind });
                }
              }

              return ok({
                issue_number: issueNumber,
                issue_url: issueUrl,
                pr_number: prNumber,
                head_sha: headSha,
                head_ref: headRef,
                comment_body: commentBody,
                trigger_kind: triggerKind,
                mention_type: mentionType,
              });
            } catch (e) {
              return skip(`failed-get-pr:${e.message}`, { issue_number: issueNumber, issue_url: issueUrl, pr_number: prNumber, comment_body: commentBody, trigger_kind: triggerKind });
            }
          }
          
          // ここから issue のコメントによる発火

          const createdAt = String(comment?.created_at || '');
          const ts = formatUtcYmdHm(createdAt || null);

          // breakdown モードの場合、Issue に milestone が紐付いているかチェック
          if (mode === 'breakdown') {
            const milestone = issue?.milestone;
            if (!milestone) {
              // milestone が紐付いていない場合、警告コメントを投稿してスキップ
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: Number(issueNumber),
                  body: '> [!WARNING]\n> `[breakdown]` は Milestone に紐づいた Issue でのみ実行できます。\n> この Issue を Milestone に追加してから再度お試しください。'
                });
              } catch (e) {
                core.warning(`Failed to post warning comment: ${e.message}`);
              }
              return skip('breakdown-requires-milestone', { issue_number: issueNumber, issue_url: issueUrl, comment_body: commentBody, trigger_kind: triggerKind });
            }

            // milestone 情報を出力に含める
            return ok({
              issue_number: issueNumber,
              issue_url: issueUrl,
              pr_number: '',
              head_sha: '',
              head_ref: '',
              comment_body: commentBody,
              trigger_kind: triggerKind,
              mention_type: mentionType,
              milestone_number: milestone.number,
              milestone_title: milestone.title,
            });
          }

          return ok({
            issue_number: issueNumber,
            issue_url: issueUrl,
            pr_number: '',
            head_sha: '',
            head_ref: '',
            comment_body: commentBody,
            trigger_kind: triggerKind,
            mention_type: mentionType,
          });
