name: "Run Codex"
description: "Codex ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè¡Œã‚’è¡Œã†å…±é€šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆGitHub é€£æºæ©Ÿèƒ½ä»˜ãï¼‰"

inputs:
  codex_code_oauth_token:
    description: "Codex Code OAuth Token / API ã‚­ãƒ¼"
    required: false
    default: ""
  codex_auth_json:
    description: "Codex èªè¨¼æƒ…å ±ï¼ˆauth.json ã® Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å€¤ï¼‰"
    required: false
    default: ""
  github_token:
    description: "GitHub ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ»gh CLI èªè¨¼ã«ä½¿ç”¨ï¼‰"
    required: false
    default: ""
  prompt:
    description: "Codex ã«æ¸¡ã™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
    required: true
  issue_number:
    description: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ Issue/PR ç•ªå·ï¼ˆç©ºã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
    required: false
    default: ""
  pr_number:
    description: "PR ç•ªå·ï¼ˆPR ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã«ä½¿ç”¨ã€‚ç©ºã®å ´åˆã¯ Issue ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰"
    required: false
    default: ""
  head_ref:
    description: "PR ã® head ãƒ–ãƒ©ãƒ³ãƒåï¼ˆãƒ–ãƒ©ãƒ³ãƒãƒªãƒ³ã‚¯è¡¨ç¤ºã«ä½¿ç”¨ï¼‰"
    required: false
    default: ""
  auto_commit:
    description: "Codex å®Ÿè¡Œå¾Œã«ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‹"
    required: false
    default: "true"
  create_branch:
    description: "å®Ÿè¡Œå‰ã«æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã‹ï¼ˆIssue èµ·ç‚¹ã®å®Ÿè£…ã§ä½¿ç”¨ï¼‰"
    required: false
    default: "false"
  branch_prefix:
    description: "ä½œæˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã®æ¥é ­è¾"
    required: false
    default: "codex/"
  model:
    description: "Codex ã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«åï¼ˆä¾‹: o4-mini, o3, gpt-4.1ï¼‰ã€‚ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨"
    required: false
    default: ""
  reasoning_effort:
    description: "o-series ãƒ¢ãƒ‡ãƒ«ã®æ¨è«–ãƒ¬ãƒ™ãƒ«ï¼ˆlow, medium, highï¼‰ã€‚ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"
    required: false
    default: ""

outputs:
  codex_response:
    description: "Codex ã®å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ï¼ˆCLI ãƒ‘ã‚¹ã®ã¿ï¼‰"
    value: ${{ steps.codex_output.outputs.response }}

runs:
  using: "composite"
  steps:
    # 1. èªè¨¼æƒ…å ±ã®æ¤œè¨¼
    - name: Validate Codex credentials
      shell: bash
      env:
        CODEX_TOKEN: ${{ inputs.codex_code_oauth_token }}
        CODEX_AUTH_JSON: ${{ inputs.codex_auth_json }}
      run: |
        if [ -z "$CODEX_TOKEN" ] && [ -z "$CODEX_AUTH_JSON" ]; then
          echo "::error::codex_code_oauth_token ã¾ãŸã¯ codex_auth_json ã®ã„ãšã‚Œã‹ãŒå¿…é ˆã§ã™"
          exit 1
        fi

    # 2. Git ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆCodex ãŒå†…éƒ¨ã§ git æ“ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å®Ÿè¡Œå‰ã«è¨­å®šï¼‰
    - name: Configure git user
      shell: bash
      run: |
        git config user.name "codex[bot]"
        git config user.email "codex[bot]@users.noreply.github.com"

    # 2.5. .codex/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®äº‹å‰å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    - name: Check .codex/ directory pre-existence
      id: codex_dir
      shell: bash
      run: |
        # .codex/ å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ git ã§è¿½è·¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ .codex/ ã‚’ç®¡ç†ç”¨ã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ã„ã‚‹å ´åˆã®ã¿ tracked=true
        if git ls-files .codex/ 2>/dev/null | grep -q .; then
          echo "tracked=true" >> $GITHUB_OUTPUT
          echo ".codex/ ã¯ãƒªãƒã‚¸ãƒˆãƒªã§è¿½è·¡ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼‰"
        else
          echo "tracked=false" >> $GITHUB_OUTPUT
          echo ".codex/ ã¯ãƒªãƒã‚¸ãƒˆãƒªã§è¿½è·¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆè‡ªå‹•ç”Ÿæˆã‚’ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰é™¤å¤–ï¼‰"
        fi

    # 3. ãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆIssue èµ·ç‚¹ã®å®Ÿè£…æ™‚ï¼‰
    - name: Create branch for issue
      if: inputs.create_branch == 'true' && inputs.issue_number != ''
      id: branch
      shell: bash
      env:
        BRANCH_PREFIX: ${{ inputs.branch_prefix }}
        ISSUE_NUMBER: ${{ inputs.issue_number }}
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="${BRANCH_PREFIX}issue-${ISSUE_NUMBER}-${TIMESTAMP}"
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

        git checkout -b "$BRANCH_NAME"
        echo "ãƒ–ãƒ©ãƒ³ãƒ '${BRANCH_NAME}' ã‚’ä½œæˆã—ã¾ã—ãŸ"

    # 4. PR/Issue ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åé›† + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ‹¡å……
    - name: Collect context
      id: context
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        PR_NUMBER: ${{ inputs.pr_number }}
        ISSUE_NUMBER: ${{ inputs.issue_number }}
        ORIGINAL_PROMPT: ${{ inputs.prompt }}
        AUTO_COMMIT: ${{ inputs.auto_commit }}
      run: |
        CONTEXT=""

        # PR ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
        if [ -n "$PR_NUMBER" ] && [ -n "$GH_TOKEN" ]; then
          echo "PR #${PR_NUMBER} ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ä¸­..."

          # PR ã®æ¦‚è¦å–å¾—
          if ! PR_BODY=$(gh pr view "$PR_NUMBER" --json title,body --jq '"# PR #" + (.number|tostring) + ": " + .title + "\n\n" + .body' 2>&1); then
            echo "::warning::PR æ¦‚è¦ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${PR_BODY}"
            PR_BODY=""
          fi
          if [ -n "$PR_BODY" ]; then
            CONTEXT="${CONTEXT}

        --- PR æ¦‚è¦ ---
        ${PR_BODY}"
          fi

          # PR ã®å·®åˆ†å–å¾—ï¼ˆå¤§è¦æ¨¡ PR ã§ã®è² è·è»½æ¸›ã®ãŸã‚æœ€å¤§ 5000 è¡Œã«åˆ¶é™ï¼‰
          if ! PR_DIFF=$(gh pr diff "$PR_NUMBER" 2>&1 | head -5000); then
            echo "::warning::PR å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${PR_DIFF}"
            PR_DIFF=""
          fi
          if [ -n "$PR_DIFF" ]; then
            CONTEXT="${CONTEXT}

        --- PR å·®åˆ† ---
        ${PR_DIFF}"
          fi

          # PR ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          if ! PR_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' 2>&1); then
            echo "::warning::PR å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${PR_FILES}"
            PR_FILES=""
          fi
          if [ -n "$PR_FILES" ]; then
            CONTEXT="${CONTEXT}

        --- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ---
        ${PR_FILES}"
          fi

        # Issue ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ï¼ˆPR ã§ãªã„å ´åˆï¼‰
        elif [ -n "$ISSUE_NUMBER" ] && [ -n "$GH_TOKEN" ]; then
          echo "Issue #${ISSUE_NUMBER} ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ä¸­..."

          if ! ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json title,body --jq '"# Issue #" + (.number|tostring) + ": " + .title + "\n\n" + .body' 2>&1); then
            echo "::warning::Issue æ¦‚è¦ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${ISSUE_BODY}"
            ISSUE_BODY=""
          fi
          if [ -n "$ISSUE_BODY" ]; then
            CONTEXT="${CONTEXT}

        --- Issue æ¦‚è¦ ---
        ${ISSUE_BODY}"
          fi
        fi

        # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ããƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
        ENRICHED_PROMPT="$ORIGINAL_PROMPT"

        if [ -n "$CONTEXT" ]; then
          ENRICHED_PROMPT="${ENRICHED_PROMPT}

        ä»¥ä¸‹ã¯ã“ã®ã‚¿ã‚¹ã‚¯ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã§ã™:
        ${CONTEXT}"
        fi

        # auto_commit æ™‚: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”ŸæˆæŒ‡ç¤ºã‚’è¿½åŠ 
        if [ "$AUTO_COMMIT" = "true" ]; then
          ENRICHED_PROMPT="${ENRICHED_PROMPT}

        ---
        ã€é‡è¦ã€‘ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸå ´åˆã€å¤‰æ›´å†…å®¹ã‚’è¦ç´„ã—ãŸ Conventional Commits å½¢å¼ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¥æœ¬èªï¼‰ã‚’ \`.codex-commit-msg\` ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¦ãã ã•ã„ã€‚
        å½¢å¼: 1è¡Œç›®ã«ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: feat: â—‹â—‹ã‚’è¿½åŠ ï¼‰ã€ç©ºè¡Œã®å¾Œã«è©³ç´°ã‚’è¨˜è¿°ã€‚"
        fi

        # ä½œæ¥­ã‚µãƒãƒªãƒ¼æŒ‡ç¤ºã‚’è¿½åŠ ï¼ˆå…¨ãƒ‘ã‚¹å…±é€šï¼‰
        ENRICHED_PROMPT="${ENRICHED_PROMPT}

        ---
        ã€é‡è¦ã€‘ä½œæ¥­å®Œäº†å¾Œã€ä½œæ¥­å†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’ \`.codex-summary.md\` ã« Markdown å½¢å¼ã§æ›¸ãå‡ºã—ã¦ãã ã•ã„ã€‚
        å®Ÿè£…ã®å ´åˆã¯å¤‰æ›´å†…å®¹ã®æ¦‚è¦ã‚’ã€ç›¸è«‡ãƒ»è³ªå•ã¸ã®å›ç­”ã®å ´åˆã¯çµè«–ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"

        # è¤‡æ•°è¡Œå‡ºåŠ›ã‚’ GITHUB_OUTPUT ã«è¨­å®š
        echo "enriched_prompt<<CODEX_PROMPT_EOF" >> $GITHUB_OUTPUT
        echo "$ENRICHED_PROMPT" >> $GITHUB_OUTPUT
        echo "CODEX_PROMPT_EOF" >> $GITHUB_OUTPUT

    # 5. é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿
    - name: Codex å®Ÿè¡Œé–‹å§‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: inputs.issue_number != '' && inputs.github_token != ''
      id: progress
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const branchName = '${{ steps.branch.outputs.branch_name }}' || '${{ inputs.head_ref }}';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          let body = `â³ **Codex** ãŒå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ... â€” [ã‚¸ãƒ§ãƒ–ã‚’è¡¨ç¤º](${runUrl})`;
          if (branchName) {
            body += `\nãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\``;
          }
          const { data: comment } = await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: Number('${{ inputs.issue_number }}'),
            body: body
          });
          core.setOutput('comment_id', String(comment.id));

    # 6A. API ã‚­ãƒ¼ãƒ‘ã‚¹: Codex GitHub Action ã§å®Ÿè¡Œ
    - name: Run Codex GitHub Action (API ã‚­ãƒ¼)
      if: inputs.codex_code_oauth_token != ''
      uses: openai/codex-github-action@v1
      with:
        prompt: ${{ steps.context.outputs.enriched_prompt }}
      env:
        OPENAI_API_KEY: ${{ inputs.codex_code_oauth_token }}
        GITHUB_TOKEN: ${{ inputs.github_token }}

    # 6B. auth.json ãƒ‘ã‚¹: CLI ã§ç›´æ¥å®Ÿè¡Œï¼ˆå‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
    - name: Setup Node.js for Codex CLI
      if: inputs.codex_code_oauth_token == ''
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Run Codex CLI (auth.json)
      if: inputs.codex_code_oauth_token == ''
      id: codex_cli
      shell: bash
      env:
        PROMPT: ${{ steps.context.outputs.enriched_prompt }}
        CODEX_AUTH_JSON: ${{ inputs.codex_auth_json }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        GH_TOKEN: ${{ inputs.github_token }}
        MODEL: ${{ inputs.model }}
        REASONING_EFFORT: ${{ inputs.reasoning_effort }}
      run: |
        set -eo pipefail

        # auth.json ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if [ -n "$CODEX_AUTH_JSON" ]; then
          CODEX_HOME="${HOME}/.codex"
          mkdir -p "$CODEX_HOME"
          if ! echo "$CODEX_AUTH_JSON" | base64 -d > "$CODEX_HOME/auth.json"; then
            echo "::error::codex_auth_json ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æœ‰åŠ¹ãª Base64 ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi
          chmod 600 "$CODEX_HOME/auth.json"
        fi

        # @openai/codex ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if ! npm install -g @openai/codex; then
          echo "::error::@openai/codex ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸã€‚npm ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1
        fi

        # gh CLI ã¯ GITHUB_TOKEN / GH_TOKEN ç’°å¢ƒå¤‰æ•°ã§è‡ªå‹•èªè¨¼ã•ã‚Œã‚‹
        # Codex ãŒ --full-auto ãƒ¢ãƒ¼ãƒ‰ã§ gh ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ»Issue ä½œæˆç­‰ãŒå¯èƒ½

        # Codex å®Ÿè¡Œï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ»æ¨è«–ãƒ¬ãƒ™ãƒ«æŒ‡å®šãŒã‚ã‚‹å ´åˆã¯ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ï¼‰
        CODEX_ARGS="--full-auto"
        if [ -n "$MODEL" ]; then
          CODEX_ARGS="$CODEX_ARGS --model $MODEL"
        fi
        if [ -n "$REASONING_EFFORT" ]; then
          CODEX_ARGS="$CODEX_ARGS --reasoning-effort $REASONING_EFFORT"
        fi
        if ! codex $CODEX_ARGS "$PROMPT" 2>&1 | tee /tmp/codex-output.txt; then
          echo "::error::Codex ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼æƒ…å ±ã¨å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1
        fi

    # 7. Codex å‡ºåŠ›ã®èª­ã¿è¾¼ã¿
    - name: Codex å‡ºåŠ›ã®èª­ã¿è¾¼ã¿
      if: always()
      id: codex_output
      shell: bash
      run: |
        RESPONSE=""

        # Codex ãŒç”Ÿæˆã—ãŸã‚µãƒãƒªãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆ
        if [ -f .codex-summary.md ]; then
          RESPONSE=$(head -c 50000 .codex-summary.md)
        # CLI ãƒ‘ã‚¹ã® stdout å‡ºåŠ›ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
        elif [ -f /tmp/codex-output.txt ]; then
          RESPONSE=$(tail -100 /tmp/codex-output.txt | head -c 50000)
        fi

        if [ -z "$RESPONSE" ]; then
          RESPONSE="ï¼ˆå‡ºåŠ›ãªã—ï¼‰"
        fi

        # ãƒ©ãƒ³ãƒ€ãƒ ãª EOF ãƒãƒ¼ã‚«ãƒ¼ã§å®‰å…¨ã«è¤‡æ•°è¡Œå‡ºåŠ›ã‚’è¨­å®š
        EOF_MARKER="EOF_CODEX_$(date +%s%N)"
        echo "response<<${EOF_MARKER}" >> $GITHUB_OUTPUT
        echo "$RESPONSE" >> $GITHUB_OUTPUT
        echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

    # 8. Codex ä½œæ¥­ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚³ãƒŸãƒƒãƒˆå‰ï¼‰
    - name: Codex ä½œæ¥­ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if: inputs.auto_commit == 'true'
      shell: bash
      env:
        CODEX_DIR_TRACKED: ${{ steps.codex_dir.outputs.tracked }}
      run: |
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚é€€é¿ï¼ˆå¾Œã§ä½¿ç”¨ï¼‰
        if [ -f .codex-commit-msg ]; then
          cp .codex-commit-msg /tmp/codex-commit-msg
        fi

        # Codex ä½œæ¥­ç”¨ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
        rm -f .codex-commit-msg .codex-summary.md .codex-issues.json

        # auth.json ãŒãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ„ãƒªãƒ¼ã«ç´›ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
        find . -name "auth.json" -path "*/.codex/*" -delete 2>/dev/null || true

        # .codex/ ãŒãƒªãƒã‚¸ãƒˆãƒªã§è¿½è·¡ã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã€Codex ãŒè‡ªå‹•ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å‰Šé™¤
        # ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ .codex/ ã‚’å®šç¾©ã—ã¦ã„ãªã„ãƒªãƒã‚¸ãƒˆãƒªã«è‡ªå‹•ã§ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’é˜²æ­¢ï¼‰
        if [ "$CODEX_DIR_TRACKED" != "true" ] && [ -d .codex ]; then
          echo ".codex/ ã¯ãƒªãƒã‚¸ãƒˆãƒªã§è¿½è·¡ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™"
          rm -rf .codex/
        fi

    # 9. ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
    - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      if: inputs.auto_commit == 'true'
      id: commit
      shell: bash
      env:
        BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        CODEX_DIR_TRACKED: ${{ steps.codex_dir.outputs.tracked }}
      run: |
        # å·®åˆ†ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if [ -z "$(git status --porcelain)" ]; then
          echo "changes_pushed=false" >> $GITHUB_OUTPUT
          echo "ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—: ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          exit 0
        fi

        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add -A

        # å®‰å…¨ã®ãŸã‚ Codex ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»auth.json ã‚’ã‚¢ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸
        git reset HEAD -- .codex-commit-msg .codex-summary.md .codex-issues.json 2>/dev/null || true
        # auth.json ã‚’å«ã‚€ãƒ‘ã‚¹ã‚’ã‚¢ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸
        git diff --cached --name-only | grep 'auth\.json' | xargs -r git reset HEAD -- 2>/dev/null || true

        # .codex/ ãŒãƒªãƒã‚¸ãƒˆãƒªã§è¿½è·¡ã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã€å…¨ä½“ã‚’ã‚¢ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸
        # ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ã¦ã„ãªã„ .codex/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
        if [ "$CODEX_DIR_TRACKED" != "true" ]; then
          git reset HEAD -- .codex/ 2>/dev/null || true
        fi

        # ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚‹ã‹å†ç¢ºèª
        if [ -z "$(git diff --cached --name-only)" ]; then
          echo "changes_pushed=false" >> $GITHUB_OUTPUT
          echo "ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãªã—: ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          exit 0
        fi

        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ±ºå®šï¼ˆCodex ãŒç”Ÿæˆã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å„ªå…ˆï¼‰
        if [ -f /tmp/codex-commit-msg ]; then
          COMMIT_MSG=$(cat /tmp/codex-commit-msg)
        else
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
          CHANGED_FILES=$(git diff --cached --name-only | head -20)
          FILE_COUNT=$(git diff --cached --name-only | wc -l | tr -d ' ')
          COMMIT_MSG="feat: Codex ã«ã‚ˆã‚‹å¤‰æ›´

        å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ« (${FILE_COUNT}ä»¶):
        ${CHANGED_FILES}"
        fi

        git commit -m "${COMMIT_MSG}

        Co-Authored-By: Codex <codex[bot]@users.noreply.github.com>"

        if [ -n "$BRANCH_NAME" ]; then
          # æ–°è¦ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯ upstream ã‚’è¨­å®šã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
          git push -u origin "$BRANCH_NAME"
        else
          git push origin HEAD
        fi
        echo "changes_pushed=true" >> $GITHUB_OUTPUT

    # 10. ç©ºãƒ–ãƒ©ãƒ³ãƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: ç©ºãƒ–ãƒ©ãƒ³ãƒã®å‰Šé™¤
      if: always() && inputs.create_branch == 'true' && steps.branch.outputs.branch_name != ''
      shell: bash
      env:
        BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        CHANGES_PUSHED: ${{ steps.commit.outputs.changes_pushed }}
      run: |
        # å¤‰æ›´ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
        if [ "$CHANGES_PUSHED" != "true" ]; then
          # ãƒ–ãƒ©ãƒ³ãƒãŒãƒªãƒ¢ãƒ¼ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "å¤‰æ›´ãªã—: ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒ '${BRANCH_NAME}' ã‚’å‰Šé™¤ã—ã¾ã™"
            git push origin --delete "$BRANCH_NAME" || echo "::warning::ãƒ–ãƒ©ãƒ³ãƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
          else
            echo "ãƒ–ãƒ©ãƒ³ãƒ '${BRANCH_NAME}' ã¯ãƒªãƒ¢ãƒ¼ãƒˆã«å­˜åœ¨ã—ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi
        fi

    # 11. auth.json ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: Cleanup auth.json
      if: always() && inputs.codex_auth_json != ''
      shell: bash
      run: |
        CODEX_HOME="${HOME}/.codex"
        if [ -f "$CODEX_HOME/auth.json" ]; then
          rm -f "$CODEX_HOME/auth.json"
          echo "auth.json ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
        fi
        # ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ„ãƒªãƒ¼ã® Codex ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆ.codex/ è‡ªä½“ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®ãŸã‚æ®‹ã™ï¼‰
        rm -f .codex-commit-msg .codex-summary.md .codex-issues.json
        # ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ„ãƒªãƒ¼ã® auth.json ã‚‚ç¢ºå®Ÿã«å‰Šé™¤
        find . -name "auth.json" -path "*/.codex/*" -delete 2>/dev/null || true

    # 12. çµæœã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ï¼ˆæˆåŠŸæ™‚ï¼‰
    - name: å®Ÿè¡Œçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: inputs.issue_number != '' && inputs.github_token != '' && steps.progress.outputs.comment_id != ''
      uses: actions/github-script@v7
      env:
        CODEX_RESPONSE: ${{ steps.codex_output.outputs.response }}
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const changesPushed = '${{ steps.commit.outputs.changes_pushed }}' === 'true';
          const autoCommit = '${{ inputs.auto_commit }}' === 'true';
          const branchName = '${{ steps.branch.outputs.branch_name }}' || '${{ inputs.head_ref }}';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const codexResponse = process.env.CODEX_RESPONSE || '';

          let body = '### âœ… Codex å®Ÿè¡Œå®Œäº†\n\n';

          // Codex ã®ä½œæ¥­ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
          if (codexResponse && codexResponse !== 'ï¼ˆå‡ºåŠ›ãªã—ï¼‰') {
            body += codexResponse + '\n\n';
          }

          if (autoCommit && changesPushed) {
            body += '---\n\nã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸã€‚\n\n';

            // ãƒ–ãƒ©ãƒ³ãƒãƒªãƒ³ã‚¯ã®è¡¨ç¤º
            if (branchName) {
              const branchUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/tree/${branchName}`;
              body += `**ãƒ–ãƒ©ãƒ³ãƒ**: [\`${branchName}\`](${branchUrl})\n`;
            }

            // PR ä½œæˆãƒªãƒ³ã‚¯ï¼ˆæ–°è¦ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿ï¼‰
            if ('${{ inputs.create_branch }}' === 'true' && branchName) {
              const prUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/compare/${branchName}?expand=1`;
              body += `\n[ğŸ“ PR ã‚’ä½œæˆã™ã‚‹](${prUrl})\n`;
            }
          } else if (autoCommit) {
            body += '---\n\nå®Ÿè¡Œã¯å®Œäº†ã—ã¾ã—ãŸãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
          }

          body += `\n\n---\n[ã‚¸ãƒ§ãƒ–ã‚’è¡¨ç¤º](${runUrl})`;

          await github.rest.issues.updateComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: Number('${{ steps.progress.outputs.comment_id }}'),
            body: body
          });

    # 13. ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
    - name: ã‚¨ãƒ©ãƒ¼çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: failure() && inputs.issue_number != '' && inputs.github_token != '' && steps.progress.outputs.comment_id != ''
      uses: actions/github-script@v7
      env:
        CODEX_RESPONSE: ${{ steps.codex_output.outputs.response }}
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const codexResponse = process.env.CODEX_RESPONSE || '';

          let body = '### âŒ Codex å®Ÿè¡Œå¤±æ•—\n\n';

          if (codexResponse && codexResponse !== 'ï¼ˆå‡ºåŠ›ãªã—ï¼‰') {
            body += '**å®Ÿè¡Œãƒ­ã‚°:**\n\n' + codexResponse + '\n\n---\n\n';
          }

          body += `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${runUrl}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;

          await github.rest.issues.updateComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: Number('${{ steps.progress.outputs.comment_id }}'),
            body: body
          });
