name: Claude Implement
run-name: claude-impl issue #${{ github.event.issue.number }}

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: claude-impl-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  impl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository to access local actions
        uses: actions/checkout@v4

      - name: Prepare context
        id: prep
        uses: ./.github/actions/prepare-claude-context
        with:
          mode: "implement"
          impl_workflow_id: claude-impl.yml
          create_pr_on_issue: "true"
          issue_branch_prefix: "claude/issue-"
          pr_title_prefix: "Claude:"
          pr_body_template: |
            This PR was created from issue #{{issue_number}}.

      - name: Debug prepare outputs
        run: |
          echo "should_run=${{ steps.prep.outputs.should_run }}"
          echo "reason=${{ steps.prep.outputs.reason }}"
          echo "trigger_kind=${{ steps.prep.outputs.trigger_kind }}"
          echo "pr_number=${{ steps.prep.outputs.pr_number }}"
          echo "head_sha=${{ steps.prep.outputs.head_sha }}"
          echo "head_ref=${{ steps.prep.outputs.head_ref }}"

      - name: Cancel running reviews for this PR
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: ./.github/actions/cancel-claude-runs
        with:
          workflow_id: claude-review.yml
          pr_number: ${{ steps.prep.outputs.pr_number }}
          head_ref: ${{ steps.prep.outputs.head_ref }}
          head_sha: ${{ steps.prep.outputs.head_sha }}

      - name: Checkout repository
        if: steps.prep.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prep.outputs.head_ref }}
          fetch-depth: 0

      # --- プロジェクトの環境設定をここに追加 ---
      # 例: Node.js
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #
      # - name: Install dependencies
      #   run: npm install
      # ------------------------------------

      - name: Run Claude (implement)
        if: steps.prep.outputs.should_run == 'true'
        uses: ./.github/actions/run-claude
        with:
          comment_body: ${{ steps.prep.outputs.comment_body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # default_model: 'opus'
          # default_max_turns: 20
          # allowed_tools: |
          #   Bash(npm run lint)
          #   Bash(npm run test)