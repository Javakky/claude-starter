name: Claude Code

on:
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write # workflow runsの読み書きに必要
  id-token: write

jobs:
  claude:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '[review]')

    steps:
      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.payload.issue.pull_request) {
              core.warning('Comment is not on a PR. Skipping conflict check.');
              core.setOutput('should_skip_check', 'true');
              return;
            }
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('should_skip_check', 'false');

      - name: Handle conflicting workflows
        if: steps.pr_info.outputs.should_skip_check == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const headRef = "${{ steps.pr_info.outputs.head_ref }}";
            const currentRunId = ${{ github.run_id }};

            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: headRef,
              status: 'in_progress'
            });

            const conflictingRuns = runs.workflow_runs.filter(run => {
              return run.id !== currentRunId && (run.name === 'Claude Code' || run.name === 'Claude Review');
            });

            if (conflictingRuns.length > 0) {
              core.warning(`Found ${conflictingRuns.length} conflicting runs. Cancelling them...`);
              for (const run of conflictingRuns) {
                core.warning(`- Cancelling run #${run.id} (${run.name})`);
                await github.rest.actions.cancelWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
              }
              core.info("Proceeding with this run as it contains the latest instructions.");
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude
        uses: ./../actions/run-claude # Use the local composite action for dogfooding
        with:
          github_token: ${{ github.token }}
          comment_body: ${{ github.event.comment.body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # このリポジトリではデフォルトを上書きしてテスト
          default_max_turns: 300
