name: Claude Implement
run-name: claude-impl issue #${{ github.event.issue.number }}

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: claude-impl-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  impl:
    runs-on: ubuntu-latest
    steps:
      # ローカル action を読むために checkout は必要
      # ここではデフォルトブランチを取る（issue起点 implement は Claude 側がブランチ作成する想定）
      - name: Checkout repository to access local actions
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare context
        id: prep
        uses: ./.github/actions/prepare-claude-context
        with:
          mode: "implement"
          impl_workflow_id: claude.yml # ←この workflow ファイル名に合わせる（ファイル名変えるならここも変える）

      - name: Debug prepare outputs
        run: |
          echo "should_run=${{ steps.prep.outputs.should_run }}"
          echo "reason=${{ steps.prep.outputs.reason }}"
          echo "trigger_kind=${{ steps.prep.outputs.trigger_kind }}"
          echo "issue_number=${{ steps.prep.outputs.issue_number }}"
          echo "pr_number=${{ steps.prep.outputs.pr_number }}"
          echo "head_sha=${{ steps.prep.outputs.head_sha }}"
          echo "head_ref=${{ steps.prep.outputs.head_ref }}"
          echo "issue_url=${{ steps.prep.outputs.issue_url }}"

      # PR上の@claude(implement)であれば、そのPRの review を止めたい（任意）
      - name: Cancel running reviews for this PR
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: ./.github/actions/cancel-claude-runs
        with:
          workflow_id: claude-review.yml
          pr_number: ${{ steps.prep.outputs.pr_number }}
          head_ref: ${{ steps.prep.outputs.head_ref }}
          head_sha: ${{ steps.prep.outputs.head_sha }}

      # PR conversation から呼ばれた場合だけ、そのブランチへ checkout し直す
      - name: Checkout PR head branch
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.head_ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prep.outputs.head_ref }}
          fetch-depth: 0

      - name: Run Claude (implement)
        if: steps.prep.outputs.should_run == 'true'
        uses: ./.github/actions/run-claude
        with:
          # Issue起点でもPR起点でも、@claude を含む本文がそのままClaudeに渡る
          comment_body: ${{ steps.prep.outputs.comment_body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
