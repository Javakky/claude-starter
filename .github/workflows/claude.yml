name: Claude Implement
run-name: claude-impl issue #${{ github.event.issue.number }}

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: claude-impl-${{ github.event.issue.number }}-${{ github.event.comment.user.type == 'Bot' && 'bot' || 'user' }}
  cancel-in-progress: true

jobs:
  impl:
    runs-on: ubuntu-latest
    steps:
      # ローカル action を読むための checkout（デフォルトブランチでOK）
      - name: Checkout repository to access local actions
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare context
        id: prep
        uses: ./.github/actions/prepare-claude-context
        with:
          mode: "implement"
          impl_workflow_id: Claude.yml
          # Issue起点の枝名を Claude 側に合わせて事前作成する（A案）
          issue_branch_prefix: "claude/issue-"
          compare_base_branch: "master"
          allowed_comment_permissions: "admin,maintain,write"
          max_workflow_runs_to_scan: "50"

      - name: Debug prepare outputs
        run: |
          echo "should_run=${{ steps.prep.outputs.should_run }}"
          echo "reason=${{ steps.prep.outputs.reason }}"
          echo "trigger_kind=${{ steps.prep.outputs.trigger_kind }}"
          echo "issue_number=${{ steps.prep.outputs.issue_number }}"
          echo "pr_number=${{ steps.prep.outputs.pr_number }}"
          echo "head_sha=${{ steps.prep.outputs.head_sha }}"
          echo "head_ref=${{ steps.prep.outputs.head_ref }}"
          echo "issue_url=${{ steps.prep.outputs.issue_url }}"

      # PR上で implement が走る場合だけ、そのPRの review を止める（任意）
      - name: Cancel running reviews for this PR
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: ./.github/actions/cancel-claude-runs
        with:
          workflow_id: claude-review.yml
          pr_number: ${{ steps.prep.outputs.pr_number }}
          head_ref: ${{ steps.prep.outputs.head_ref }}
          head_sha: ${{ steps.prep.outputs.head_sha }}

      # ★重要修正点：
      # Issue起点 implement の head_ref は「Claude が checkout -b するために存在させた枝」なので
      # ここで checkout すると claude-code-action 側の checkout -b と衝突して落ちる。
      # よって「PR conversation のときだけ」 checkout する。
      - name: Checkout PR head branch (PR conversation only)
        if: steps.prep.outputs.should_run == 'true' && steps.prep.outputs.pr_number != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prep.outputs.head_ref }}
          fetch-depth: 0

      - name: Run Claude (implement)
        if: steps.prep.outputs.should_run == 'true'
        uses: ./.github/actions/run-claude
        with:
          comment_body: ${{ steps.prep.outputs.comment_body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
