name: Claude Review
run-name: claude-review pr #${{ github.event.pull_request.number || github.event.issue.number }} (${{ github.event_name }})

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare context
        id: prep
        uses: Javakky/claude-starter/.github/actions/prepare-claude-context@@REF@@
        with:
          mode: review
          impl_workflow_id: claude-impl.yml
          skip_commit_prefixes: "docs:,style:,chore:,wip:"
          allow_final_sync_during_impl: "true"
          # optional: implement最終コミット判定のマーカー（使わないなら空のままでOK）
          final_sync_commit_marker: ""

      - name: Checkout repository
        if: steps.prep.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prep.outputs.head_sha }}
          fetch-depth: 0

      - name: Run Claude Review
        if: steps.prep.outputs.should_run == 'true'
        uses: Javakky/claude-starter/.github/actions/run-claude-review@@REF@@
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
