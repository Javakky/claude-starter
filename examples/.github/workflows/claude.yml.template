name: Claude

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: claude-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}-${{ github.event.sender.type == 'Bot' && 'bot' || 'user' }}
  cancel-in-progress: true

jobs:
  prepare:
    if: github.event_name == 'pull_request' || github.actor != 'claude'
    runs-on: ubuntu-latest
    outputs:
      run_type: ${{ steps.detect.outputs.run_type }}
    steps:
      - id: detect
        shell: bash
        env:
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
        run: |
          body="$COMMENT_BODY"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "run_type=review" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$body" != *"@claude"* ]]; then
            echo "run_type=skip" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$body" == *"[review]"* ]]; then
            echo "run_type=review" >> "$GITHUB_OUTPUT"
          else
            echo "run_type=task" >> "$GITHUB_OUTPUT"
          fi

  task:
    needs: prepare
    if: needs.prepare.outputs.run_type == 'task'
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Claude Run
        id: prepare
        uses: Javakky/claude-starter/.github/actions/prepare-claude-run@@REF@@
        # No inputs needed for 'task' run type, it uses the context directly.

      - name: Checkout repository
        if: steps.prepare.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prepare.outputs.head_sha }}
          fetch-depth: 0

      # --- プロジェクトの環境設定をここに追加 ---
      # 例: Node.js
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #
      # - name: Install dependencies
      #   run: npm install
      # ------------------------------------

      - name: Run Claude
        if: steps.prepare.outputs.should_run == 'true'
        uses: Javakky/claude-starter/.github/actions/run-claude@@REF@@
        with:
          comment_body: ${{ github.event.comment.body || github.event.pull_request.body || '' }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # default_model: 'opus'
          # default_max_turns: 20
          # allowed_tools: |
          #   Bash(npm run lint)
          #   Bash(npm run test)

  review:
    needs: prepare
    if: needs.prepare.outputs.run_type == 'review'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout for history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Claude Run
        id: prepare
        uses: Javakky/claude-starter/.github/actions/prepare-claude-run@@REF@@
        with:
          run_type: 'review'
          github_event_before: ${{ github.event.before }}
          github_event_after: ${{ github.event.after }}

      - name: Checkout PR head
        if: steps.prepare.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prepare.outputs.head_sha }}
          fetch-depth: 0

      - name: Run Claude Review
        if: steps.prepare.outputs.should_run == 'true'
        uses: Javakky/claude-starter/.github/actions/run-claude-review@@REF@@
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # model: 'opus'
