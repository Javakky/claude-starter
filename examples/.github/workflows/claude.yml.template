name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [ created ]

permissions:
  contents: write
  pull-requests: write # PR情報を読み取るために必要
  issues: write
  actions: write # 実行中のワークフローをキャンセルするために必要

jobs:
  claude:
    runs-on: ubuntu-latest
    # `@claude` を含み、かつ `[review]` を含まないコメントでのみ実行
    if: contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '[review]')
    steps:
      - name: Prepare Claude Run
        id: prepare
        uses: Javakky/claude-starter/.github/actions/prepare-claude-run@@REF@@

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.prepare.outputs.head_sha }}
          fetch-depth: 0

      # --- プロジェクトの環境設定をここに追加 ---
      # 例: Node.js
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #
      # - name: Install dependencies
      #   run: npm install
      # ------------------------------------

      - name: Run Claude
        uses: Javakky/claude-starter/.github/actions/run-claude@@REF@@
        with:
          github_token: ${{ github.token }}
          comment_body: ${{ github.event.comment.body }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # default_model: 'opus'
          # default_max_turns: 20
          # allowed_tools: |
          #   Bash(npm run lint)
          #   Bash(npm run test)
