name: Claude Review

on:
  pull_request:
    types: [ opened, synchronize ]
  issue_comment:
    types: [ created ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write # workflow runsの読み書きに必要

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@claude') &&
        contains(github.event.comment.body, '[review]'))
    steps:
      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, headSha, headRef;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              headSha = context.payload.pull_request.head.sha;
              headRef = context.payload.pull_request.head.ref;
            } else { // issue_comment
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              prNumber = context.issue.number;
              headSha = pr.head.sha;
              headRef = pr.head.ref;
            }
            core.setOutput('pr_number', prNumber);
            core.setOutput('head_sha', headSha);
            core.setOutput('head_ref', headRef);

      - name: Handle conflicting workflows
        uses: actions/github-script@v7
        with:
          script: |
            const headRef = "${{ steps.pr_info.outputs.head_ref }}";
            const currentRunId = ${{ github.run_id }};

            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: headRef,
              status: 'in_progress'
            });

            const conflictingRuns = runs.workflow_runs.filter(run => {
              return run.id !== currentRunId && (run.name === 'Claude' || run.name === 'Claude Review');
            });

            if (conflictingRuns.length > 0) {
              core.warning(`Found ${conflictingRuns.length} conflicting runs. Cancelling them...`);
              for (const run of conflictingRuns) {
                core.warning(`- Cancelling run #${run.id} (${run.name})`);
                await github.rest.actions.cancelWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
              }
              core.info("Proceeding with this run as it contains the latest instructions.");
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.head_sha }}
          fetch-depth: 0

      - name: Run Claude Review
        uses: Javakky/claude-starter/.github/actions/run-claude-review@@REF@@
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # 必要に応じてデフォルト値をオーバーライド
          # model: 'opus'
